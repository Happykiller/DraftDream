tasks:
  build:
    desc: "Build all Docker images in parallel"
    cmd: "docker compose build --parallel"
  up-dev:
    desc: "Start development stack (dev profile)"
    cmd: "docker compose --profile dev up -d"
  logs:
    desc: "Tail stack logs (last 200 lines)"
    cmd: "docker compose logs -f --tail=200"
  test:
    desc: "Compile API service as a smoke check"
    cmd: "docker compose run --rm api npm run build"
  deploy:
    desc: "Build, export, and install production images"
    cmd: "make -f Makefile.old deploy-prod"
    confirm: true
  fix-502:
    desc: "Diagnose and fix 502 on /graphql via nginx upstream"
    cmd: >
      bash -lc '
      set -euo pipefail;
      docker compose ps;
      docker compose exec nginx nginx -t;
      docker compose exec nginx getent hosts api || true;
      docker compose exec nginx curl -sS -I http://api:3000/graphql || true;
      '
